# Implementation Plan v0.3 â€” **Sandpack Migration**

> *This supersedes Implementation Plan v0.2.*
> Reflects migration from `@webcontainer/api` to `@codesandbox/sandpack-react`.

---

## ðŸ”„ Key Changes from v0.2

| Area                 | Change                                                                                                        |
| -------------------- | ------------------------------------------------------------------------------------------------------------- |
| **Runtime**          | Replaced **WebContainer (`@webcontainer/api`)** with **Sandpack (`@codesandbox/sandpack-react`)**.             |
| **Execution Model**  | Shifted from running user's dev server (`webContainer.spawn`) to **Sandpack's internal bundler/preview**.      |
| **File System**      | Replaced WebContainer VFS (`webContainer.fs`) with **Sandpack state management** (`files` prop, `updateCode` hook). |
| **Phase 2**          | Refocused on **Sandpack setup and file handling adaptation**.                                                  |
| **Phase 6**          | Redefined as **Interactive Preview via Sandpack**, removing direct execution steps (install, spawn).           |
| **AST Integration**  | **Temporarily Removed:** Tree-sitter/AST parsing removed due to COEP header conflicts. Needs re-implementation compatible with Sandpack. |
| **Code Generation**  | Phase 5/7 edits will use `recast` + `prettier` + **Sandpack's `updateCode`** for saving (when AST is restored). |
| **Preview**          | Uses `<SandpackPreview>` component. **Preview is working successfully.**                                       |
| **Communication**    | Leverages **Sandpack's client API** for `postMessage` between host and preview iframe (when needed for Phase 5). |
| **Headers**          | COOP/COEP headers in `next.config.ts` removed as Tree-sitter is temporarily disabled.                          |

---

## Phase 1 â€“ Core Infrastructure & Public GitHub Loading *(completed)*
_No scope changes; retained for completeness._

1. Next.js + Tailwind scaffold
2. Radixâ€¯UI / shadcn primitives (Button,â€¯Input)
3. GitHub unauthenticated repo fetch (Octokit)
4. Monaco Editor embed
5. ~~COOP/COEP headers for WebContainer compatibility~~ **Removed** (as Tree-sitter removed)

---

## Phase 2 â€“ **Sandpack Integration & File Management** *(Mostly Complete)*

| Task                            | Output                                                                                                |
| ------------------------------- | ----------------------------------------------------------------------------------------------------- |
| Install Sandpack deps           | `@codesandbox/sandpack-react` added, `@webcontainer/api` removed.                                        |
| Implement `<SandpackProvider>`  | Root provider setup with appropriate template and initial `files` prop.                            |
| Adapt GitHub loading            | Fetched files loaded into the `files` prop of `<SandpackProvider>`.                                      |
| Refactor FS Helpers             | `readFile`, `writeFile` mapped to Sandpack state/hooks (`useSandpack`, `useActiveCode`, `updateCode`). |
| Adapt Editor Integration        | Editor uses `useActiveCode` to display and `updateCode` to save changes. *(Custom Monaco pending)*       |
| Implement `SandpackLayout`      | Use components like `<SandpackCodeEditor>`, `<SandpackPreview>`, `<SandpackFileExplorer>`.              |
| **File Update Handling**        | **Deferred:** Depends on AST registry re-implementation.                                                |

---

## Phase 3 â€“ **AST Core & Client-Side Parsing** *(Needs Re-Implementation)*

### Goal
Re-implement AST Registry compatible with Sandpack using **@babel/parser** for **client-side parsing** and manipulation, thus avoiding browser COEP/COOP security constraints related to WASM/SharedArrayBuffer.

### Deliverables
- **Client-Side:**
    - `@babel/parser` dependency added to `package.json`. Code generation deps (`recast`, `prettier`) likely needed here or in Phase 5. Ensure parser plugins (`@babel/plugin-syntax-jsx`, `@babel/plugin-syntax-typescript`) are available/installed.
    - `web-tree-sitter` dependency and Node.js Tree-sitter dependencies (`tree-sitter`, grammars) removed.
    - `/public/wasm` directory removed.
    - `useAstRegistry` hook (or equivalent) refactored/created:
        - Manages client-side state: Map to store **Babel AST File** objects (generated by `@babel/parser`), parsing status (idle, parsing, ready, error), error messages.
        - Identifies relevant source files from Sandpack state (`sandpack.files`).
        - **Parses files directly on the client using @babel/parser** with **JSX and TypeScript plugins** (`lib/ast/parser.ts`) when Sandpack files change or are initially loaded.
        - **Triggers `data-uid` injection** (`lib/ast/instrumentation.ts`) into the AST and builds/updates the UID-to-ASTNode map after successful parsing.
        - **Debounces** parsing/instrumentation triggered by frequent changes (e.g., editor typing).
        - Updates the client-side AST map and UID map with the results.
- *Deferred:* Jest tests for client hook and parsing/instrumentation logic.

### Pipeline (Client-Side Parsing & Instrumentation for Registry Sync)
```mermaid
graph TD
  A[Sandpack File Change Event (via updateCode or initial load)] --> B(Client: useAstRegistry Hook)
  B --> |Debounce Timer for edits| B
  B --> C(Client: Identify Changed/Relevant File)
  C --> D{Client: Parse w/ **Babel**}
  D -- AST --> E{Client: Inject `data-uid` & Build UID Map}
  E -- Instrumented AST & UID Map --> B
  B --> F{Client: Update AST Registry Map & UID Map}
  F --> |AST for analysis| G(Code Intel / Editor)
  F --> |AST for edits| H(Design Canvas / Phase 5)
```

---

## Phase 4 â€“ Design Mode: Isolated Vite Preview *(Skipped/Obsolete)*

> **Reason for Skip:** This approach involved creating a separate Vite application (`/preview-app`) to render components in isolation. It introduced complexities with build configuration, aliasing, and maintaining synchronization. The strategy pivoted to running the user's *actual* development server directly within the WebContainer (now covered in Phase 6), providing a more realistic and integrated preview experience.

---

## Phase 5 â€“ **Design Mode & AST-Based Edits** *(Depends on P3)*

*Implement interactive visual editing backed by AST manipulation within the Sandpack context.*

**Depends on Phase 3:** Requires the **client-side AST registry populated by @babel/parser**.

**Goal:** Allow users to click elements in the **Sandpack preview**, inspect/edit props using data derived from the **client-side AST registry**, perform AST patching and code generation **on the client**, and save changes back using **Sandpack's `updateCode`**. This relies on mapping DOM elements to AST nodes via injected unique identifiers (`data-uid`).

**Workflow (Client-Side Edits with `data-uid` Mapping):**
1.  **AST Pre-processing (Client-side, tied to P3):** When ASTs are generated/updated by `useAstRegistry` (P3):
    *   Traverse the @babel/parser AST.
    *   Inject a unique identifier (e.g., `data-uid="<unique_id>"`) as a JSX attribute into relevant opening elements.
    *   Build/update a client-side map (`Map<string, ASTNode>`) linking these unique IDs to their corresponding AST nodes.
    *   Generate code *with* the injected `data-uid` attributes using Recast/Prettier.
    *   This instrumented code is what's provided to Sandpack.
2.  Activate Design Mode.
3.  **Element Selection in Sandpack Preview:** User clicks an element in the preview iframe (Requires instrumentation + `postMessage` - P5-04, P6-07).
4.  **DOM-to-AST Mapping:**
    *   The click handler reads the `data-uid` attribute from the clicked DOM element.
    *   Uses the client-side UID-to-AST map (from step 1) to instantly retrieve the corresponding AST node.
5.  Prop Extraction (Uses **client-side @babel/parser AST registry**, operating on the node found in step 4).
6.  Inspector Panel displays props for the selected node.
7.  Apply Changes (User edits props in the Inspector).
8.  **Client-Side AST Patching:** Modify the specific AST node object (found via the map) held in the client-side registry (e.g., using `recast` or manual traversal).
9.  **Client-Side Code Generation:** Generate new source code string for the *entire modified file* from its updated AST (e.g., using `recast`/`prettier`). This regenerated code will naturally include the previously injected `data-uid` attributes (or they can be re-injected if the generation process loses them).
10. **Write File (Client):** Save the new code string to Sandpack state via `updateCode` hook.
11. **Sandpack Sync:** `updateCode` triggers Sandpack state change -> HMR updates preview.
12. **AST Registry Sync:** The file change detected by `useAstRegistry` (from step 10) triggers a **debounced client-side re-parsing** with @babel/parser for the **single changed file**. This re-parsing *also re-runs the `data-uid` injection and map update* (step 1), keeping the registry and map consistent.
13. Deactivate mode.

| Layer          | Detail                                                                                              |
| -------------- | --------------------------------------------------------------------------------------------------- |
| **Deps**       | `@babel/parser` (from P3), `recast`, `prettier`, `nanoid` (or other UUID generator)                     |
| **Interaction**| `postMessage` (Sandpack client API), DOM listeners reading `data-uid`, Element ID (`data-uid`)        |
| **Mapping**    | **Inject `data-uid` into JSX via AST transform** â†’ Build **UID-to-AST Node Map** â†’ Read `data-uid` on click. |
| **AST Edit**   | Find node via UID map, modify props (**operating client-side** on @babel/parser AST from registry)        |
| **Codeâ€‘gen**   | `recast` / `prettier` (**client-side**), ensuring `data-uid` attributes persist or are re-injected.   |
| **Saving**     | Use **`updateCode`** from Sandpack's `useActiveCode` hook.                                         |
| **AST Sync**   | **Client-side** `useAstRegistry` hook re-parses + **re-injects `data-uid`** post-save.               |
| **UI**         | Design Mode toggle, Inspector Panel                                                                 |
| **E2E**        | Test full loop: click â†’ edit â†’ save â†’ verify code state (`data-uid` present) & **Sandpack preview** update. |

---

## Phase 6 â€“ **Interactive Preview via Sandpack** *(Complete)*

*Leverages Sandpack's built-in bundler and preview component.* 

1.  **Setup `<SandpackProvider>`:** **Done.** Configured with project `files`, template. Dependencies handled. 
2.  **Render `<SandpackPreview>`:** **Done.** Preview is working. âœ…
3.  **Enable Iframe Communication:** **Deferred.** Depends on Phase 5 implementation. 
4.  **HMR:** **Pending Verification.** Depends on Phase 5 edits via `updateCode`.

*Obsolete Steps (Handled by Sandpack):*
- Reading `package.json` for scripts/manager.
- Running `npm install`.
- Spawning the dev server process.
- Capturing the preview URL.

---

## Phase 7 â€“ AI Agent Integration *(Partially Blocked by P3/P5)*

*Leverages Sandpack for file operations and @babel/parser for code manipulation.*

**Blocked:** The `editFile` tool requires AST functionality (Phase 3) and potentially the codegen logic (Phase 5).

- Tools:
    - `readFile`: Reads content from Sandpack state (`sandpack.files`). *(Implementable)*
    - `editFile`: Uses **client-side AST Registry (@babel/parser)** + Codeâ€‘gen (`recast`/`prettier`) + **Sandpack's `updateCode`** for saving. *(Blocked by P3/P5)*
- Chat endpoint/UI remain the same.

---

## Phase 8 â€“ Advanced / Backlog *(placeholders)*

*No changes*

---

## Fileâ€‘Structure Adjustments *(Reflecting Client-Side Parsing)*

```
src/
  components/
    design/
      Inspector.tsx     # (Phase 5 - Depends on P3)
    sandpack/         # Optional: Custom Sandpack wrapper components?
  hooks/
    useAstRegistry.ts # Re-implement for client-side @babel/parser parsing, instrumentation, map mgmt
  context/
    AstRegistryContext.tsx  # Re-implement for client-side @babel/parser
  lib/
    ast/              # Adapt for @babel/parser / Babel AST
      parser.ts       # Client-side @babel/parser parsing logic
      traversal.ts    # Adapt/Use utils like estraverse (for instrumentation, prop extraction)
      instrumentation.ts # **NEW:** Logic for injecting `data-uid` & building map
      mapper.ts       # Adapt for @babel/parser AST <-> UI mapping
      codegen.ts      # Client-side code generation (Recast/Prettier, handles `data-uid`)
      ~~clientRegistry.ts~~ # **REMOVED/Merged:** Logic integrated into useAstRegistry hook
    sandpack/         # Helpers for Sandpack interaction (if needed)
      files.ts        # (Example: Adapted FS helpers)
  ...
  api/                # (No /api/ast/parse endpoint needed)
```

---

## Dependencies (Relevant - Reflecting Client-Side @babel/parser)

```json
{
  "dependencies": {
    "@codesandbox/sandpack-react": "^2.20.0",
    "@babel/parser": "^7.22.5", // AST Parser (Client-side)
    "recast": "^0.23", // AST Manipulation / Codegen
    "prettier": "^3.3", // Code Formatting
    // "escodegen": "...", // Alternative/supplement to Recast for codegen if needed
    // "estraverse": "...", // Optional: AST traversal utility
    // ... other deps
  },
  "devDependencies": {
    // tree-sitter, tree-sitter-javascript, etc. REMOVED
    // path-browserify REMOVED (if related to WASM loading)
    // ...
  }
}
```

---

### Migration Notes

- Sandpack preview is now functional after removing Tree-sitter and related COEP/COOP headers.
- **Next major step is re-implementing AST parsing and instrumentation** (Phase 3) using **client-side @babel/parser**.
- File system operations are now state management operations on the Sandpack `